{"version":3,"sources":["webpack://flowers-webgl/./src/ts/corolla.ts","webpack://flowers-webgl/./src/ts/flower.ts","webpack://flowers-webgl/./src/ts/flowers-manager.ts","webpack://flowers-webgl/./src/ts/force-field.ts","webpack://flowers-webgl/./src/ts/gl-utils/gl-canvas.ts","webpack://flowers-webgl/./src/ts/gl-utils/gl-resource.ts","webpack://flowers-webgl/./src/ts/gl-utils/shader-manager.ts","webpack://flowers-webgl/./src/ts/gl-utils/shader-sources.ts","webpack://flowers-webgl/./src/ts/gl-utils/shader.ts","webpack://flowers-webgl/./src/ts/helpers.ts","webpack://flowers-webgl/./src/ts/noise.ts","webpack://flowers-webgl/./src/ts/parameters.ts","webpack://flowers-webgl/./src/ts/plotting/color.ts","webpack://flowers-webgl/./src/ts/plotting/plotter-canvas-2d.ts","webpack://flowers-webgl/./src/ts/plotting/plotter-canvas-base.ts","webpack://flowers-webgl/./src/ts/plotting/plotter-canvas-webgl.ts","webpack://flowers-webgl/./src/ts/plotting/plotter-svg.ts","webpack://flowers-webgl/./src/ts/plotting/plotter.ts","webpack://flowers-webgl/./src/ts/rope.ts","webpack://flowers-webgl/webpack/bootstrap","webpack://flowers-webgl/./src/ts/main.ts"],"names":["random","randomChannel","this","position","x","y","color","Noise","randomInRange","Math","floor","Color","attachedPetals","computePetals","floatingPetals","outline","Corolla","computeOutline","noise","update","dt","length","detachedPetal","pop","center","rotationSpeed","push","petalArea","orientation","trimFloatingPetals","wind","compute","Parameters","draw","plotter","drawOutline","drawPetals","getAcceleration","forceField","acceleration","min","UPWARD_FORCE","fieldForce","computeForce","isDead","lowestAllowed","allPetals","concat","singlePetalColor","petalColor","drawEllipses","drawPolygon","iP","max","width","height","splice","nbPetals","result","i","PI","outlineNbPoints","outlineRadius","angle","radius","cos","sin","attachPoint","nbNodes","Flower","maxSegmentLength","stem","Rope","corolla","attachCorolla","corollaAcceleration","dampening","getDrawableStem","getDrawableLine","drawCorolla","highestPoint","endPosition","flowers","reset","manage","domainWidth","domainHeight","idealNumberOfFlowers","round","flowersDensity","newFlower","FlowersManager","createFlower","iF","stems","flower","drawLines","flowerLength","mousePosition","maxInfluenceDistance","fleeMouseEnabled","fleeMouse","location","fromMouseX","fromMouseY","distanceToMouse","sqrt","mouseInfluence","ForceField","gl","initGL","flags","setError","message","Page","Demopage","setErrorMessage","canvas","Canvas","getCanvas","getContext","disable","CULL_FACE","DEPTH_TEST","BLEND","clearColor","adjustSize","hidpi","cssPixel","window","devicePixelRatio","clientWidth","clientHeight","_gl","GLResource","cachedShaders","buildShader","infos","callback","sourcesPending","sourcesFailed","loadedSource","success","processSource","source","replace","match","name","injected","shader","vert","ShaderSources","getSource","vertexFilename","frag","fragmentFilename","processedVert","processedFrag","Shader","loadSource","getShader","registerShader","callAndClearCallbacks","cached","callbacks","cachedCallback","failed","pending","builtShader","deleteShader","freeGLResources","cachedSources","filename","text","XMLHttpRequest","open","onload","readyState","status","responseText","console","error","statusText","onerror","send","notImplemented","alert","types","str","binder","value","uniform2fv","uniform3fv","uniform4fv","uniform2iv","uniform3iv","uniform4iv","uniform1i","uniformMatrix2fv","uniformMatrix3fv","uniformMatrix4fv","unitNb","activeTexture","bindTexture","TEXTURE_2D","TEXTURE_CUBE_MAP","Array","isArray","uniform1iv","uniform1fv","uniform1f","vertexSource","fragmentSource","createShader","type","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","id","uCount","aCount","vertexShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","introspection","getProgramInfoLog","deleteProgram","use","useProgram","bindUniforms","currTextureUnitNb","Object","keys","u","forEach","uName","uniform","loc","bindAttributes","a","aName","attribute","VBO","bind","bindUniformsAndAttributes","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","size","ACTIVE_ATTRIBUTES","getActiveAttrib","getAttribLocation","downloadTextFile","fileName","content","fileType","blob","Blob","navigator","msSaveBlob","URL","createObjectURL","linkElement","document","createElement","download","href","dataset","downloadurl","style","display","body","appendChild","click","removeChild","setTimeout","revokeObjectURL","period","time","last","next","randomVector","r","from","to","controlId","callObservers","observers","observer","resetObservers","downloadObservers","getColor","rgb","ColorPicker","getValue","g","b","backgroundColor","addObserver","linesColor","petalsColor","getMousePosition","canvasSize","getSize","Range","Checkbox","isChecked","addResetObserver","addDownloadObserver","toLowerCase","indexOf","updatePetalColorsVisibility","visible","Controls","setVisibility","Button","rNormalized","gNormalized","bNormalized","toStringRGB","toStringRGBA","alpha","ellipsePolyfill","centerX","centerY","radiusX","radiusY","arc","context","lineWidth","initializeInternal","fillStyle","fillColor","fillRect","finalize","lines","strokeStyle","lineColor","beginPath","line","moveTo","lineTo","stroke","closePath","polygon","offset","fill","ellipses","ellipseOpacity","ellipse","PlotterCanvas","PlotterCanvas2D","adjustToCanvas","actualWidth","actualHeight","_width","_height","Plotter","EBatchType","loadShader","ShaderManager","errorMessage","Error","enable","blendFunc","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","depthFunc","LEQUAL","clearDepth","linesVBOId","createBuffer","ellipsesVBOId","corollaVBOId","corollaIndexVBOId","linesShader","ellipsesShader","polygonsShader","viewport","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","batches","linesBatch","polygonsBatch","ellipsesBatch","batch","LINES","POLYGONS","ELLIPSES","drawLinesBatches","depthMask","drawPolygonsBatches","drawEllipseBatches","nonTrivalLines","nbSegments","batchId","point","polygonBatch","ellipsesList","totalNbSegments","buffer","Float32Array","bindBuffer","ARRAY_BUFFER","bufferData","DYNAMIC_DRAW","aVertexLoc","enableVertexAttribArray","batchStartIndex","computeBatchDepth","vertexAttribPointer","FLOAT","nbVertices","drawArrays","totalNbVertices","totalNbTriangles","totalNbLines","verticesBuffer","iVertice","polygonDepth","outlinePoint","indicesBuffer","Uint16Array","iIndex","iVerticeIndex","indexOfPolygonCenter","iPoint","aDataLoc","ELEMENT_ARRAY_BUFFER","drawElements","TRIANGLES","UNSIGNED_SHORT","totalNbPoints","ellipseBatch","batchDepth","widestSide","ceil","proportions","encodedDimensions","aData1Loc","aData2Loc","POINTS","PlotterCanvasWebGL","stringParts","toString","join","PlotterSvg","computePath","transform","toFixed","radian","start","pathParts","initialize","createRopeNode","pos","previousPos","acc","startingPoint","segmentLength","totalLength","nodes","iN","abs","minSegmentLength","computeSmoothLine","origin","endAcceleration","applyForces","applyVerlet","applyConstraints","highest","node","newPosX","newPosY","dX","dY","distanceToPrevious","correction","correctionX","correctionY","minimumPoints","points","subdivideLine","sourcePoints","ratio","newPoints","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","call","plot","flowersManager","petalsOpacity","useCanvas2D","svgText","exportAsSvg","lastUpdate","performance","now","requestAnimationFrame","mainLoop","speed","mousePositionInPixels","main"],"mappings":"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","file":"main.min.js","sourcesContent":["import { ForceField } from \"./force-field\";\r\nimport { IEllipse, IPoint, IVector } from \"./interfaces\";\r\nimport { Noise } from \"./noise\";\r\nimport { Parameters } from \"./parameters\";\r\nimport { Color } from \"./plotting/color\";\r\nimport { Plotter } from \"./plotting/plotter\";\r\n\r\n\r\ninterface IPetal extends IEllipse {\r\n    petalArea: number;\r\n    rotationSpeed: number;\r\n}\r\n\r\nfunction randomColor(): Color {\r\n    const random = Noise.randomInRange(0, 3);\r\n    const randomChannel = Math.floor(0.5 * 255 * (random % 1));\r\n\r\n    if (random < 1) {\r\n        return new Color(255, 0, 255 - randomChannel);\r\n    } else if (random < 2) {\r\n        return new Color(255, randomChannel, 0);\r\n    } else if (random < 3) {\r\n        return new Color(255 - randomChannel, 255, 0);\r\n    } else if (random < 4) {\r\n        return new Color(0, 255, randomChannel);\r\n    } else if (random < 5) {\r\n        return new Color(0, 255 - randomChannel, 255);\r\n    } else {\r\n        return new Color(randomChannel, 0, 255);\r\n    }\r\n}\r\n\r\nconst PETALS_DROP_RATE = 0.1;\r\n\r\nclass Corolla {\r\n    public readonly position: IPoint; // readonly because attachedPetals reference it\r\n\r\n    private readonly color: Color;\r\n    private readonly attachedPetals: IPetal[];\r\n    private readonly floatingPetals: IPetal[];\r\n    private readonly outline: IPoint[];\r\n\r\n    private readonly noise: Noise;\r\n    private wind: IVector;\r\n\r\n    public constructor() {\r\n        this.position = { x: 0, y: 0 };\r\n        this.color = randomColor();\r\n        this.attachedPetals = this.computePetals(10);\r\n        this.floatingPetals = [];\r\n        this.outline = Corolla.computeOutline(40, 20);\r\n\r\n        this.noise = new Noise(Noise.randomInRange(1, 2));\r\n    }\r\n\r\n    public update(dt: number): void {\r\n        if (this.attachedPetals.length > 0 && Math.random() < PETALS_DROP_RATE * dt) {\r\n            const detachedPetal = this.attachedPetals.pop();\r\n            detachedPetal.center = { x: this.position.x, y: this.position.y };\r\n            detachedPetal.rotationSpeed = Noise.randomInRange(-1.5, 1.5);\r\n            this.floatingPetals.push(detachedPetal);\r\n        }\r\n\r\n        for (const detachedPetal of this.floatingPetals) {\r\n            detachedPetal.center.y -= 0.05 * detachedPetal.petalArea * dt;\r\n            detachedPetal.orientation += detachedPetal.rotationSpeed * dt;\r\n        }\r\n        this.trimFloatingPetals();\r\n\r\n        this.wind = this.noise.compute(dt);\r\n        this.wind.x = Parameters.wind * 10000 * (this.wind.x - 0.5);\r\n        this.wind.y = 1000 * (this.wind.y - 0.5);\r\n    }\r\n\r\n    public draw(plotter: Plotter): void {\r\n        this.drawOutline(plotter);\r\n        this.drawPetals(plotter);\r\n    }\r\n\r\n    public getAcceleration(forceField: ForceField): IVector {\r\n        const acceleration: IVector = { x: 0, y: 0 };\r\n        acceleration.x += this.wind.x * Math.min(1, this.attachedPetals.length / 16);\r\n        acceleration.y += this.wind.y;\r\n\r\n        const DOWNWARD_FORCE = 10000;\r\n        const UPWARD_FORCE = [7000, 10000, 11000, 12000];\r\n        acceleration.y += DOWNWARD_FORCE - UPWARD_FORCE[Math.min(UPWARD_FORCE.length - 1, this.attachedPetals.length)];\r\n\r\n        const fieldForce = forceField.computeForce(this.position);\r\n        acceleration.x += 2000 * fieldForce.x;\r\n        acceleration.y += 2000 * fieldForce.y;\r\n\r\n        return acceleration;\r\n    }\r\n\r\n    public isDead(lowestAllowed: number): boolean {\r\n        return this.attachedPetals.length <= 0 && this.floatingPetals.length <= 0 && this.position.y > lowestAllowed + 50;\r\n    }\r\n\r\n    private drawPetals(plotter: Plotter): void {\r\n        const allPetals = this.attachedPetals.concat(this.floatingPetals);\r\n        const color = Parameters.singlePetalColor ? Parameters.petalColor : this.color;\r\n        plotter.drawEllipses(allPetals, color);\r\n    }\r\n\r\n    private drawOutline(plotter: Plotter): void {\r\n        plotter.drawPolygon(this.outline, this.position);\r\n    }\r\n\r\n    private trimFloatingPetals(): void {\r\n        for (let iP = this.floatingPetals.length - 1; iP >= 0; iP--) {\r\n            const highestPoint = this.floatingPetals[iP].center.y + 0.5 * Math.max(this.floatingPetals[iP].width, this.floatingPetals[iP].height);\r\n            if (highestPoint < 0) {\r\n                this.floatingPetals.splice(iP, 1);\r\n                iP--;\r\n            }\r\n        }\r\n    }\r\n\r\n    private computePetals(nbPetals: number): IPetal[] {\r\n        const result: IPetal[] = [];\r\n\r\n        for (let i = 0; i < nbPetals; i++) {\r\n            const width = Noise.randomInRange(50, 70);\r\n            const proportions = Noise.randomInRange(0.3, 0.7);\r\n            const height = proportions * width;\r\n            const orientation = Noise.randomInRange(0, 2 * Math.PI);\r\n\r\n            result.push({\r\n                width,\r\n                height,\r\n                orientation,\r\n                center: this.position,\r\n                petalArea: width * height,\r\n                rotationSpeed: 0,\r\n            });\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    private static computeOutline(outlineNbPoints: number, outlineRadius: number): IPoint[] {\r\n        const result: IPoint[] = [];\r\n\r\n        for (let i = 0; i < outlineNbPoints; i++) {\r\n            const angle = 2 * Math.PI * i / (outlineNbPoints - 1);\r\n            const radius = outlineRadius * Noise.randomInRange(1, 1.3);\r\n            result.push({\r\n                x: radius * Math.cos(angle),\r\n                y: radius * Math.sin(angle),\r\n            });\r\n        }\r\n\r\n        return result;\r\n    }\r\n}\r\n\r\nexport { Corolla };\r\n\r\n","import { Corolla } from \"./corolla\";\r\nimport { ForceField } from \"./force-field\";\r\nimport { IPoint } from \"./interfaces\";\r\nimport { Parameters } from \"./parameters\";\r\nimport { Line, Plotter } from \"./plotting/plotter\";\r\nimport { Rope } from \"./rope\";\r\n\r\n\r\nclass Flower {\r\n    public static readonly maxSegmentLength: number = 20;\r\n\r\n    private readonly attachPoint: IPoint;\r\n    private readonly stem: Rope;\r\n    private readonly corolla: Corolla;\r\n\r\n    public constructor(attachPoint: IPoint, length: number) {\r\n        this.attachPoint = attachPoint;\r\n\r\n        const nbNodes = Math.max(length / Flower.maxSegmentLength);\r\n        this.stem = new Rope(attachPoint, length / nbNodes, nbNodes);\r\n\r\n        this.corolla = new Corolla();\r\n        this.attachCorolla();\r\n    }\r\n\r\n    public update(dt: number, forceField: ForceField): void {\r\n        this.corolla.update(dt);\r\n        const corollaAcceleration = this.corolla.getAcceleration(forceField);\r\n        this.stem.dampening = Parameters.dampening;\r\n        this.stem.update(dt, this.attachPoint, corollaAcceleration);\r\n        this.attachCorolla();\r\n    }\r\n\r\n    public getDrawableStem(): Line {\r\n        return this.stem.getDrawableLine(5);\r\n    }\r\n\r\n    public drawCorolla(plotter: Plotter): void {\r\n        this.corolla.draw(plotter);\r\n    }\r\n\r\n    public isDead(lowestAllowed: number): boolean {\r\n        return this.corolla.isDead(lowestAllowed) && this.stem.highestPoint >= lowestAllowed;\r\n    }\r\n\r\n    private attachCorolla(): void {\r\n        this.corolla.position.x = this.stem.endPosition.x;\r\n        this.corolla.position.y = this.stem.endPosition.y;\r\n    }\r\n}\r\n\r\nexport { Flower };\r\n\r\n","import { Flower } from \"./flower\";\r\nimport { ForceField } from \"./force-field\";\r\nimport { IPoint } from \"./interfaces\";\r\nimport { Noise } from \"./noise\";\r\nimport { Parameters } from \"./parameters\";\r\nimport { Line, Plotter } from \"./plotting/plotter\";\r\n\r\n\r\nclass FlowersManager {\r\n    private readonly flowers: Flower[];\r\n\r\n    public constructor() {\r\n        this.flowers = [];\r\n    }\r\n\r\n    public reset(): void {\r\n        this.flowers.length = 0;\r\n    }\r\n\r\n    public manage(domainWidth: number, domainHeight: number): void {\r\n        let idealNumberOfFlowers = Math.round(domainWidth * Parameters.flowersDensity);\r\n        if (idealNumberOfFlowers <= 0) {\r\n            idealNumberOfFlowers = 1;\r\n        }\r\n\r\n        // create new flowers if needed\r\n        while (this.flowers.length < idealNumberOfFlowers) {\r\n            const newFlower = FlowersManager.createFlower(domainWidth, domainHeight);\r\n            this.flowers.push(newFlower);\r\n        }\r\n\r\n        // handle old flowers\r\n        for (let iF = this.flowers.length - 1; iF >= 0; iF--) {\r\n            if (this.flowers[iF].isDead(domainHeight)) {\r\n                if (this.flowers.length > idealNumberOfFlowers) {\r\n                    // we have too many flowers already, kill old ones\r\n                    this.flowers.splice(iF, 1);\r\n                    iF--;\r\n                } else {\r\n                    // we must maintain this flowers count, recycle old ones\r\n                    this.flowers[iF] = FlowersManager.createFlower(domainWidth, domainHeight);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public update(dt: number, forceField: ForceField): void {\r\n        for (const flower of this.flowers) {\r\n            flower.update(dt, forceField);\r\n        }\r\n    }\r\n\r\n    public draw(plotter: Plotter): void {\r\n        const stems: Line[] = [];\r\n\r\n        for (const flower of this.flowers) {\r\n            stems.push(flower.getDrawableStem());\r\n        }\r\n\r\n        plotter.drawLines(stems);\r\n        for (const flower of this.flowers) {\r\n            flower.drawCorolla(plotter);\r\n        }\r\n    }\r\n\r\n    private static createFlower(domainWidth: number, domainHeight: number): Flower {\r\n        const attachPoint: IPoint = {\r\n            x: domainWidth * Math.random(),\r\n            y: domainHeight,\r\n        };\r\n\r\n        const flowerLength = Noise.randomInRange(0.2, 0.8) * domainHeight;\r\n        return new Flower(attachPoint, flowerLength);\r\n    }\r\n}\r\n\r\nexport { FlowersManager };\r\n\r\n","import { IPoint, IVector } from \"./interfaces\";\r\nimport { Parameters } from \"./parameters\";\r\n\r\n\r\nclass ForceField {\r\n    private readonly fleeMouseEnabled: boolean;\r\n\r\n    public constructor(private readonly mousePosition: IPoint, private readonly maxInfluenceDistance: number) {\r\n        this.fleeMouseEnabled = Parameters.fleeMouse;\r\n    }\r\n\r\n    public computeForce(location: IPoint): IVector {\r\n        if (!this.fleeMouseEnabled) {\r\n            return { x: 0, y: 0 };\r\n        }\r\n\r\n        const fromMouseX = location.x - this.mousePosition.x;\r\n        const fromMouseY = location.y - this.mousePosition.y;\r\n        const distanceToMouse = Math.sqrt(fromMouseX * fromMouseX + fromMouseY * fromMouseY);\r\n\r\n        if (distanceToMouse > this.maxInfluenceDistance) {\r\n            return { x: 0, y: 0 };\r\n        }\r\n\r\n        const mouseInfluence = 0.5 + Math.cos(Math.PI * distanceToMouse / this.maxInfluenceDistance);\r\n        return {\r\n            x: mouseInfluence * mouseInfluence * fromMouseX / distanceToMouse,\r\n            y: mouseInfluence * mouseInfluence * fromMouseY / distanceToMouse,\r\n        };\r\n    }\r\n}\r\n\r\nexport { ForceField };\r\n\r\n","import \"../page-interface-generated\";\r\n\r\nlet gl: WebGLRenderingContext = null;\r\n\r\n/** Initializes a WebGL context */\r\nfunction initGL(flags?: object): boolean {\r\n    function setError(message: string): void {\r\n        Page.Demopage.setErrorMessage(\"webgl-support\", message);\r\n    }\r\n\r\n    const canvas = Page.Canvas.getCanvas();\r\n\r\n    gl = canvas.getContext(\"webgl\", flags) as WebGLRenderingContext;\r\n    if (gl == null) {\r\n        gl = canvas.getContext(\"experimental-webgl\", flags) as WebGLRenderingContext;\r\n        if (gl == null) {\r\n            setError(\"Your browser or device does not seem to support WebGL.\");\r\n            return false;\r\n        }\r\n\r\n        setError(`Your browser or device only supports experimental WebGL.\r\nThe simulation may not run as expected.`);\r\n    }\r\n\r\n    gl.disable(gl.CULL_FACE);\r\n    gl.disable(gl.DEPTH_TEST);\r\n    gl.disable(gl.BLEND);\r\n    gl.clearColor(0, 0, 0, 1);\r\n\r\n    return true;\r\n}\r\n\r\n/* Adjusts the GL canvas size to the actual canvas element size on the page */\r\nfunction adjustSize(hidpi: boolean = false): void {\r\n    const cssPixel: number = (hidpi) ? window.devicePixelRatio : 1;\r\n\r\n    const canvas = gl.canvas as HTMLCanvasElement;\r\n\r\n    const width: number = Math.floor(canvas.clientWidth * cssPixel);\r\n    const height: number = Math.floor(canvas.clientHeight * cssPixel);\r\n    if (canvas.width !== width || canvas.height !== height) {\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n    }\r\n}\r\n\r\nexport {\r\n    adjustSize,\r\n    initGL,\r\n    gl,\r\n};\r\n","abstract class GLResource {\r\n    private _gl: WebGLRenderingContext;\r\n\r\n    constructor(gl: WebGLRenderingContext) {\r\n        this._gl = gl;\r\n    }\r\n\r\n    public gl(): WebGLRenderingContext {\r\n        return this._gl;\r\n    }\r\n\r\n    public abstract freeGLResources(): void;\r\n}\r\n\r\nexport { GLResource };\r\n","import { gl } from \"./gl-canvas\";\r\nimport { Shader } from \"./shader\";\r\nimport * as ShaderSources from \"./shader-sources\";\r\n\r\ntype RegisterCallback = (success: boolean, shader: Shader | null) => void;\r\n\r\ninterface IShaderInfos {\r\n    fragmentFilename: string;\r\n    vertexFilename: string;\r\n    injected: { [id: string]: string };\r\n}\r\n\r\ninterface ICachedShader {\r\n    shader: Shader | null;\r\n    infos: IShaderInfos;\r\n    pending: boolean;\r\n    failed: boolean;\r\n    callbacks: RegisterCallback[];\r\n}\r\n\r\nconst cachedShaders: { [id: string]: ICachedShader } = {};\r\n\r\nfunction getShader(name: string): Shader | null {\r\n    return cachedShaders[name].shader;\r\n}\r\n\r\ntype BuildCallback = (builtShader: Shader | null) => void;\r\n\r\nfunction buildShader(infos: IShaderInfos, callback: BuildCallback): void {\r\n    let sourcesPending = 2;\r\n    let sourcesFailed = 0;\r\n\r\n    function loadedSource(success: boolean): void {\r\n        function processSource(source: string): string {\r\n            return source.replace(/#INJECT\\((.*)\\)/mg, (match: string, name: string) => {\r\n                if (infos.injected[name]) {\r\n                    return infos.injected[name];\r\n                }\r\n                return match;\r\n            });\r\n        }\r\n\r\n        sourcesPending--;\r\n        if (!success) {\r\n            sourcesFailed++;\r\n        }\r\n\r\n        if (sourcesPending === 0) {\r\n            let shader = null;\r\n\r\n            if (sourcesFailed === 0) {\r\n                const vert = ShaderSources.getSource(infos.vertexFilename);\r\n                const frag = ShaderSources.getSource(infos.fragmentFilename);\r\n\r\n                const processedVert = processSource(vert);\r\n                const processedFrag = processSource(frag);\r\n\r\n                shader = new Shader(gl, processedVert, processedFrag);\r\n            }\r\n\r\n            callback(shader);\r\n        }\r\n    }\r\n\r\n    ShaderSources.loadSource(infos.vertexFilename, loadedSource);\r\n    ShaderSources.loadSource(infos.fragmentFilename, loadedSource);\r\n}\r\n\r\nfunction registerShader(name: string, infos: IShaderInfos, callback: RegisterCallback): void {\r\n    function callAndClearCallbacks(cached: ICachedShader): void {\r\n        for (const cachedCallback of cached.callbacks) {\r\n            cachedCallback(!cached.failed, cached.shader);\r\n        }\r\n\r\n        cached.callbacks = [];\r\n    }\r\n\r\n    if (typeof cachedShaders[name] === \"undefined\") {\r\n        cachedShaders[name] = {\r\n            callbacks: [callback],\r\n            failed: false,\r\n            infos,\r\n            pending: true,\r\n            shader: null,\r\n        };\r\n        const cached = cachedShaders[name];\r\n\r\n        buildShader(infos, (builtShader: Shader | null) => {\r\n            cached.pending = false;\r\n            cached.failed = builtShader === null;\r\n            cached.shader = builtShader;\r\n\r\n            callAndClearCallbacks(cached);\r\n        });\r\n    } else {\r\n        const cached = cachedShaders[name];\r\n\r\n        if (cached.pending === true) {\r\n            cached.callbacks.push(callback);\r\n        } else {\r\n            callAndClearCallbacks(cached);\r\n        }\r\n    }\r\n}\r\n\r\nfunction deleteShader(name: string): void {\r\n    if (typeof cachedShaders[name] !== \"undefined\") {\r\n        if (cachedShaders[name].shader !== null) {\r\n            cachedShaders[name].shader.freeGLResources();\r\n        }\r\n        delete cachedShaders[name];\r\n    }\r\n}\r\n\r\nexport {\r\n    buildShader,\r\n    getShader,\r\n    IShaderInfos,\r\n    registerShader,\r\n    deleteShader,\r\n};\r\n","type LoadCallback = (success: boolean)  => void;\r\n\r\ninterface ICachedSource {\r\n    text: string;\r\n    pending: boolean;\r\n    failed: boolean;\r\n    callbacks: LoadCallback[];\r\n}\r\n\r\nconst cachedSources: { [id: string]: ICachedSource } = {};\r\n\r\n/* Fetches asynchronously the shader source from server and stores it in cache. */\r\nfunction loadSource(filename: string, callback: LoadCallback): void {\r\n    function callAndClearCallbacks(cached: ICachedSource): void {\r\n        for (const cachedCallback of cached.callbacks) {\r\n            cachedCallback(!cached.failed);\r\n        }\r\n\r\n        cached.callbacks = [];\r\n    }\r\n\r\n    if (typeof cachedSources[filename] === \"undefined\") {\r\n        cachedSources[filename] = {\r\n            callbacks: [callback],\r\n            failed: false,\r\n            pending: true,\r\n            text: null,\r\n        };\r\n        const cached = cachedSources[filename];\r\n\r\n        const xhr = new XMLHttpRequest();\r\n        xhr.open(\"GET\", \"./shaders/\" + filename, true);\r\n        xhr.onload = () => {\r\n            if (xhr.readyState === 4) {\r\n                cached.pending = false;\r\n\r\n                if (xhr.status === 200) {\r\n                    cached.text = xhr.responseText;\r\n                    cached.failed = false;\r\n                } else {\r\n                    console.error(`Cannot load '${filename}' shader source: ${xhr.statusText}`);\r\n                    cached.failed = true;\r\n                }\r\n\r\n                callAndClearCallbacks(cached);\r\n            }\r\n        };\r\n        xhr.onerror = () => {\r\n            console.error(`Cannot load '${filename}' shader source: ${xhr.statusText}`);\r\n            cached.pending = false;\r\n            cached.failed = true;\r\n            callAndClearCallbacks(cached);\r\n        };\r\n\r\n        xhr.send(null);\r\n    } else {\r\n        const cached = cachedSources[filename];\r\n\r\n        if (cached.pending === true) {\r\n            cached.callbacks.push(callback);\r\n        } else {\r\n            cached.callbacks = [callback];\r\n            callAndClearCallbacks(cached);\r\n        }\r\n    }\r\n}\r\n\r\nfunction getSource(filename: string): string {\r\n    return cachedSources[filename].text;\r\n}\r\n\r\nexport {\r\n    getSource,\r\n    loadSource,\r\n};\r\n","import { GLResource } from \"./gl-resource\";\r\nimport { VBO } from \"./vbo\";\r\n\r\nfunction notImplemented(): void {\r\n    alert(\"NOT IMPLEMENTED YET\");\r\n}\r\n\r\nfunction bindUniformFloat(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number | number[]): void;\r\nfunction bindUniformFloat(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    if (Array.isArray(value)) {\r\n        gl.uniform1fv(location, value);\r\n    } else {\r\n        gl.uniform1f(location, value);\r\n    }\r\n}\r\n\r\nfunction bindUniformFloat2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform2fv(location, value);\r\n}\r\n\r\nfunction bindUniformFloat3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform3fv(location, value);\r\n}\r\n\r\nfunction bindUniformFloat4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform4fv(location, value);\r\n}\r\n\r\nfunction bindUniformInt(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number | number[]): void;\r\nfunction bindUniformInt(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    if (Array.isArray(value)) {\r\n        gl.uniform1iv(location, value);\r\n    } else {\r\n        gl.uniform1iv(location, value);\r\n    }\r\n}\r\n\r\nfunction bindUniformInt2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform2iv(location, value);\r\n}\r\n\r\nfunction bindUniformInt3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform3iv(location, value);\r\n}\r\n\r\nfunction bindUniformInt4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform4iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: boolean | number): void {\r\n    gl.uniform1i(location, +value);\r\n}\r\n\r\nfunction bindUniformBool2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform2iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform3iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform4iv(location, value);\r\n}\r\n\r\nfunction bindUniformFloatMat2(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix2fv(location, false, value);\r\n}\r\n\r\nfunction bindUniformFloatMat3(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix3fv(location, false, value);\r\n}\r\n\r\nfunction bindUniformFloatMat4(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix4fv(location, false, value);\r\n}\r\n\r\nfunction bindSampler2D(gl: WebGLRenderingContext, location: WebGLUniformLocation, unitNb: number,\r\n    value: WebGLTexture): void {\r\n    gl.uniform1i(location, unitNb);\r\n    gl.activeTexture((gl as any)[\"TEXTURE\" + unitNb] as number);\r\n    gl.bindTexture(gl.TEXTURE_2D, value);\r\n}\r\n\r\nfunction bindSamplerCube(gl: WebGLRenderingContext, location: WebGLUniformLocation, unitNb: number,\r\n    value: WebGLTexture): void {\r\n    gl.uniform1i(location, unitNb);\r\n    gl.activeTexture((gl as any)[\"TEXTURE\" + unitNb] as number);\r\n    gl.bindTexture(gl.TEXTURE_CUBE_MAP, value);\r\n}\r\n\r\n/* From WebGL spec:\r\n* http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.14 */\r\ninterface IBindingType {\r\n    str: string;\r\n    binder: (...args: any[]) => unknown;\r\n}\r\nconst types: { [index: string]: IBindingType } = {\r\n    0x8B50: { str: \"FLOAT_VEC2\", binder: bindUniformFloat2v },\r\n    0x8B51: { str: \"FLOAT_VEC3\", binder: bindUniformFloat3v },\r\n    0x8B52: { str: \"FLOAT_VEC4\", binder: bindUniformFloat4v },\r\n    0x8B53: { str: \"INT_VEC2\", binder: bindUniformInt2v },\r\n    0x8B54: { str: \"INT_VEC3\", binder: bindUniformInt3v },\r\n    0x8B55: { str: \"INT_VEC4\", binder: bindUniformInt4v },\r\n    0x8B56: { str: \"BOOL\", binder: bindUniformBool },\r\n    0x8B57: { str: \"BOOL_VEC2\", binder: bindUniformBool2v },\r\n    0x8B58: { str: \"BOOL_VEC3\", binder: bindUniformBool3v },\r\n    0x8B59: { str: \"BOOL_VEC4\", binder: bindUniformBool4v },\r\n    0x8B5A: { str: \"FLOAT_MAT2\", binder: bindUniformFloatMat2 },\r\n    0x8B5B: { str: \"FLOAT_MAT3\", binder: bindUniformFloatMat3 },\r\n    0x8B5C: { str: \"FLOAT_MAT4\", binder: bindUniformFloatMat4 },\r\n    0x8B5E: { str: \"SAMPLER_2D\", binder: bindSampler2D },\r\n    0x8B60: { str: \"SAMPLER_CUBE\", binder: bindSamplerCube },\r\n    0x1400: { str: \"BYTE\", binder: notImplemented },\r\n    0x1401: { str: \"UNSIGNED_BYTE\", binder: notImplemented },\r\n    0x1402: { str: \"SHORT\", binder: notImplemented },\r\n    0x1403: { str: \"UNSIGNED_SHORT\", binder: notImplemented },\r\n    0x1404: { str: \"INT\", binder: bindUniformInt },\r\n    0x1405: { str: \"UNSIGNED_INT\", binder: notImplemented },\r\n    0x1406: { str: \"FLOAT\", binder: bindUniformFloat },\r\n};\r\n\r\ninterface IShaderUniform {\r\n    value: boolean | boolean[] | number | number[] | WebGLTexture | WebGLTexture[];\r\n    loc: WebGLUniformLocation;\r\n    size: number;\r\n    type: number;\r\n}\r\n\r\ninterface IShaderAttribute {\r\n    VBO: VBO;\r\n    loc: GLint;\r\n    size: number;\r\n    type: number;\r\n}\r\n\r\nclass ShaderProgram extends GLResource {\r\n    public u: { [name: string]: IShaderUniform };\r\n    public a: { [name: string]: IShaderAttribute };\r\n\r\n    private id: WebGLProgram;\r\n    private uCount: number;\r\n    private aCount: number;\r\n\r\n    constructor(gl: WebGLRenderingContext, vertexSource: string, fragmentSource: string) {\r\n        function createShader(type: GLenum, source: string): WebGLShader {\r\n            const shader = gl.createShader(type);\r\n            gl.shaderSource(shader, source);\r\n            gl.compileShader(shader);\r\n\r\n            const compileSuccess = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n            if (!compileSuccess) {\r\n                console.error(gl.getShaderInfoLog(shader));\r\n                gl.deleteShader(shader);\r\n                return null;\r\n            }\r\n\r\n            return shader;\r\n        }\r\n\r\n        super(gl);\r\n\r\n        this.id = null;\r\n        this.uCount = 0;\r\n        this.aCount = 0;\r\n\r\n        const vertexShader = createShader(gl.VERTEX_SHADER, vertexSource);\r\n        const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentSource);\r\n\r\n        const id = gl.createProgram();\r\n        gl.attachShader(id, vertexShader);\r\n        gl.attachShader(id, fragmentShader);\r\n        gl.linkProgram(id);\r\n\r\n        const linkSuccess = gl.getProgramParameter(id, gl.LINK_STATUS);\r\n        if (!linkSuccess) {\r\n            console.error(gl.getProgramInfoLog(id));\r\n            gl.deleteProgram(id);\r\n        } else {\r\n            this.id = id;\r\n\r\n            this.introspection();\r\n        }\r\n    }\r\n\r\n    public freeGLResources(): void {\r\n        super.gl().deleteProgram(this.id);\r\n        this.id = null;\r\n    }\r\n\r\n    public use(): void {\r\n        super.gl().useProgram(this.id);\r\n    }\r\n\r\n    public bindUniforms(): void {\r\n        const gl: WebGLRenderingContext = super.gl();\r\n        let currTextureUnitNb: number = 0;\r\n\r\n        Object.keys(this.u).forEach((uName: string) => {\r\n            const uniform = this.u[uName];\r\n            if (uniform.value !== null) {\r\n                if (uniform.type === 0x8B5E || uniform.type === 0x8B60) {\r\n                    const unitNb: number = currTextureUnitNb;\r\n                    types[uniform.type].binder(gl, uniform.loc, unitNb, uniform.value);\r\n                    currTextureUnitNb++;\r\n                } else {\r\n                    types[uniform.type].binder(gl, uniform.loc, uniform.value);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    public bindAttributes(): void {\r\n        Object.keys(this.a).forEach((aName: string) => {\r\n            const attribute = this.a[aName];\r\n            if (attribute.VBO !== null) {\r\n                attribute.VBO.bind(attribute.loc);\r\n            }\r\n        });\r\n    }\r\n\r\n    public bindUniformsAndAttributes(): void {\r\n        this.bindUniforms();\r\n        this.bindAttributes();\r\n    }\r\n\r\n    private introspection(): void {\r\n        const gl = super.gl();\r\n\r\n        this.uCount = gl.getProgramParameter(this.id, gl.ACTIVE_UNIFORMS);\r\n        this.u = {};\r\n        for (let i = 0; i < this.uCount; i++) {\r\n            const uniform = gl.getActiveUniform(this.id, i);\r\n            const name = uniform.name;\r\n\r\n            this.u[name] = {\r\n                loc: gl.getUniformLocation(this.id, name),\r\n                size: uniform.size,\r\n                type: uniform.type,\r\n                value: null,\r\n            };\r\n        }\r\n\r\n        this.aCount = gl.getProgramParameter(this.id, gl.ACTIVE_ATTRIBUTES);\r\n        this.a = {};\r\n        for (let i = 0; i < this.aCount; i++) {\r\n            const attribute = gl.getActiveAttrib(this.id, i);\r\n            const name = attribute.name;\r\n\r\n            this.a[name] = {\r\n                VBO: null,\r\n                loc: gl.getAttribLocation(this.id, name),\r\n                size: attribute.size,\r\n                type: attribute.type,\r\n            };\r\n        }\r\n    }\r\n}\r\n\r\nexport { ShaderProgram as Shader };\r\n","function downloadTextFile(fileName: string, content: string): void {\r\n    const fileType = \"text/plain\";\r\n\r\n    const blob = new Blob([content], { type: fileType });\r\n\r\n    if (typeof window.navigator !== \"undefined\" && typeof window.navigator.msSaveBlob !== \"undefined\") { // for IE\r\n        window.navigator.msSaveBlob(blob, fileName);\r\n    } else {\r\n        const objectUrl = URL.createObjectURL(blob);\r\n\r\n        const linkElement = document.createElement('a');\r\n        linkElement.download = fileName;\r\n        linkElement.href = objectUrl;\r\n        linkElement.dataset.downloadurl = `${fileType}:${linkElement.download}:${linkElement.href}`;\r\n        linkElement.style.display = \"none\";\r\n        document.body.appendChild(linkElement);\r\n        linkElement.click();\r\n        document.body.removeChild(linkElement);\r\n\r\n        // don't forget to free the objectURL after a few seconds\r\n        setTimeout(() => {\r\n            URL.revokeObjectURL(objectUrl);\r\n        }, 5000);\r\n    }\r\n}\r\n\r\nexport { downloadTextFile };\r\n","import { IVector } from \"./interfaces\";\r\n\r\nclass Noise {\r\n    private readonly period: number;\r\n    private time: number;\r\n\r\n    public last: IVector;\r\n    public next: IVector;\r\n\r\n    public constructor(period: number) {\r\n        this.period = period;\r\n        this.time = 0;\r\n        this.last = { x: 0, y: 0 };\r\n        this.next = { x: 0, y: 0 };\r\n\r\n        this.last = Noise.randomVector();\r\n        this.next = Noise.randomVector();\r\n    }\r\n\r\n    public compute(dt: number): IVector {\r\n        this.time += dt;\r\n        if (this.time > this.period) {\r\n            this.last = this.next;\r\n            this.next = Noise.randomVector();\r\n            this.time = this.time % this.period;\r\n        }\r\n\r\n        const r = this.time / this.period;\r\n        return {\r\n            x: this.last.x * (1 - r) + this.next.x * r,\r\n            y: this.last.y * (1 - r) + this.next.y * r,\r\n        };\r\n    }\r\n\r\n    public static randomInRange(from: number, to: number): number {\r\n        return from + (to - from) * Math.random();\r\n    }\r\n\r\n    private static randomVector(): IVector {\r\n        return { x: Math.random(), y: Math.random() };\r\n    }\r\n}\r\n\r\nexport { Noise };\r\n","import { IPoint } from \"./interfaces\";\r\nimport { Color } from \"./plotting/color\";\r\n\r\nimport \"./page-interface-generated\";\r\n\r\n\r\n/* === IDs ============================================================ */\r\nconst controlId = {\r\n    FLOWERS_RANGE: \"flowers-range-id\",\r\n    WIND_RANGE: \"wind-range-id\",\r\n    SPEED_RANGE: \"speed-range-id\",\r\n    DAMPENING_RANGE: \"dampening-range-id\",\r\n    FLEE_MOUSE_CHECKBOX: \"flee-mouse-checkbox-id\",\r\n    RESET_BUTTON: \"reset-button-id\",\r\n    BACKGROUND_COLORPICKER: \"background-color-id\",\r\n    LINES_COLORPICKER: \"lines-color-id\",\r\n    PETALS_OPACITY: \"petals-opacity-range-id\",\r\n    SINGLE_PETAL_COLOR_CHECKBOX: \"single-petal-color-checkbox-id\",\r\n    PETAL_COLORPICKER: \"petal-color-id\",\r\n    DOWNLOAD_BUTTON: \"download-button-id\",\r\n};\r\n\r\n/* === OBSERVERS ====================================================== */\r\ntype Observer = () => unknown;\r\nfunction callObservers(observers: Observer[]) {\r\n    for (const observer of observers) {\r\n        observer();\r\n    }\r\n}\r\n\r\nconst resetObservers: Observer[] = [];\r\nconst downloadObservers: Observer[] = [];\r\n\r\nfunction getColor(id: string): Color {\r\n    const rgb = Page.ColorPicker.getValue(id);\r\n    return new Color(rgb.r, rgb.g, rgb.b);\r\n}\r\n\r\nlet backgroundColor: Color = getColor(controlId.BACKGROUND_COLORPICKER);\r\nPage.ColorPicker.addObserver(controlId.BACKGROUND_COLORPICKER, () => { backgroundColor = getColor(controlId.BACKGROUND_COLORPICKER); });\r\n\r\nlet linesColor: Color = getColor(controlId.LINES_COLORPICKER);\r\nPage.ColorPicker.addObserver(controlId.LINES_COLORPICKER, () => { linesColor = getColor(controlId.LINES_COLORPICKER); });\r\n\r\nlet petalsColor: Color = getColor(controlId.PETAL_COLORPICKER);\r\nPage.ColorPicker.addObserver(controlId.PETAL_COLORPICKER, () => { petalsColor = getColor(controlId.PETAL_COLORPICKER); });\r\n\r\n/* === INTERFACE ====================================================== */\r\nclass Parameters {\r\n    public static get mousePositionInPixels(): IPoint {\r\n        const mousePosition = Page.Canvas.getMousePosition();\r\n        if (mousePosition.length === 2) {\r\n            const canvasSize = Page.Canvas.getSize();\r\n            return {\r\n                x: canvasSize[0] * mousePosition[0],\r\n                y: canvasSize[1] * mousePosition[1],\r\n            };\r\n        } else {\r\n            // handles a bug where mousePosition is empty when the page is initializing\r\n            return { x: 0, y: 0 };\r\n        }\r\n    }\r\n\r\n    public static get flowersDensity(): number {\r\n        return Page.Range.getValue(controlId.FLOWERS_RANGE) * 0.25;\r\n    }\r\n\r\n    public static get wind(): number {\r\n        return Page.Range.getValue(controlId.WIND_RANGE);\r\n    }\r\n\r\n    public static get speed(): number {\r\n        return Page.Range.getValue(controlId.SPEED_RANGE);\r\n    }\r\n\r\n    public static get dampening(): number {\r\n        return 1 - 0.01 * Page.Range.getValue(controlId.DAMPENING_RANGE);\r\n    }\r\n\r\n    public static get fleeMouse(): boolean {\r\n        return Page.Checkbox.isChecked(controlId.FLEE_MOUSE_CHECKBOX);\r\n    }\r\n\r\n    public static addResetObserver(observer: Observer): void {\r\n        resetObservers.push(observer);\r\n    }\r\n\r\n    public static get backgroundColor(): Color {\r\n        return backgroundColor;\r\n    }\r\n\r\n    public static get linesColor(): Color {\r\n        return linesColor;\r\n    }\r\n\r\n    public static get petalsOpacity(): number {\r\n        return Page.Range.getValue(controlId.PETALS_OPACITY);\r\n    }\r\n\r\n    public static get singlePetalColor(): boolean {\r\n        return Page.Checkbox.isChecked(controlId.SINGLE_PETAL_COLOR_CHECKBOX);\r\n    }\r\n\r\n    public static get petalColor(): Color {\r\n        return petalsColor;\r\n    }\r\n\r\n    public static addDownloadObserver(observer: Observer): void {\r\n        downloadObservers.push(observer);\r\n    }\r\n\r\n    public static get useCanvas2D(): boolean {\r\n        const lowercaseUrl = window.location.href.toLowerCase();\r\n        return lowercaseUrl.indexOf(\"plotter=canvas2d\") >= 0;\r\n    }\r\n\r\n    private constructor() { }\r\n}\r\n\r\nfunction updatePetalColorsVisibility(): void {\r\n    const visible = Page.Checkbox.isChecked(controlId.SINGLE_PETAL_COLOR_CHECKBOX);\r\n    Page.Controls.setVisibility(controlId.PETAL_COLORPICKER, visible);\r\n}\r\nPage.Checkbox.addObserver(controlId.SINGLE_PETAL_COLOR_CHECKBOX, updatePetalColorsVisibility);\r\nupdatePetalColorsVisibility();\r\n\r\nPage.Button.addObserver(controlId.RESET_BUTTON, () => {\r\n    callObservers(resetObservers);\r\n});\r\n\r\nPage.Button.addObserver(controlId.DOWNLOAD_BUTTON, () => {\r\n    callObservers(downloadObservers);\r\n});\r\n\r\nexport {\r\n    Parameters,\r\n};\r\n\r\n","class Color {\r\n    public readonly r: number; // integer in [0,255]\r\n    public readonly g: number; // integer in [0,255]\r\n    public readonly b: number; // integer in [0,255]\r\n\r\n    public readonly rNormalized: number; // in [0,1]\r\n    public readonly gNormalized: number; // in [0,1]\r\n    public readonly bNormalized: number; // in [0,1]\r\n\r\n    public constructor(r: number, g: number, b: number) {\r\n        this.r = r;\r\n        this.g = g;\r\n        this.b = b;\r\n\r\n        this.rNormalized = r /255;\r\n        this.gNormalized = g /255;\r\n        this.bNormalized = b /255;\r\n    }\r\n\r\n    public toStringRGB(): string {\r\n        return `rgb(${this.r}, ${this.g}, ${this.b})`;\r\n    }\r\n\r\n    /**\r\n     * @param alpha in [0, 1]\r\n     */\r\n    public toStringRGBA(alpha: number): string {\r\n        return `rgba(${this.r}, ${this.g}, ${this.b}, ${alpha})`;\r\n    }\r\n}\r\n\r\nexport { Color };\r\n","import { IEllipse, IPoint } from \"../interfaces\";\r\nimport { Color } from \"./color\";\r\nimport { Line } from \"./plotter\";\r\nimport { PlotterCanvas } from \"./plotter-canvas-base\";\r\n\r\nimport \"../page-interface-generated\";\r\n\r\n\r\nfunction ellipsePolyfill(this: CanvasRenderingContext2D, centerX: number, centerY: number, radiusX: number, radiusY: number) {\r\n    this.arc(centerX, centerY, Math.max(radiusX, radiusY), 0, 2 * Math.PI);\r\n}\r\n\r\nclass PlotterCanvas2D extends PlotterCanvas {\r\n    private readonly context: CanvasRenderingContext2D;\r\n\r\n    public constructor() {\r\n        super();\r\n        this.context = this.canvas.getContext(\"2d\", { alpha: false });\r\n        this.context.lineWidth = 1; // do not adapt with cssPixel for performance reasons on mobile devices\r\n    }\r\n\r\n    protected initializeInternal(): void {\r\n        this.context.fillStyle = this.fillColor.toStringRGB();\r\n        this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    // tslint:disable-next-line no-empty\r\n    public finalize(): void { }\r\n\r\n    public drawLines(lines: Line[]): void {\r\n        if (lines.length >= 1) {\r\n            this.context.strokeStyle = this.lineColor.toStringRGB();\r\n            this.context.lineWidth = 1; // do not adapt with cssPixel for performance reasons on mobile devices\r\n\r\n            this.context.beginPath();\r\n\r\n            for (const line of lines) {\r\n                if (line.length >= 2) {\r\n                    this.context.moveTo(line[0].x * this.cssPixel, line[0].y * this.cssPixel);\r\n                    for (let iP = 1; iP < line.length; iP++) {\r\n                        this.context.lineTo(line[iP].x * this.cssPixel, line[iP].y * this.cssPixel);\r\n                    }\r\n                }\r\n            }\r\n\r\n            this.context.stroke();\r\n            this.context.closePath();\r\n        }\r\n    }\r\n\r\n    public drawPolygon(polygon: Line, offset: IPoint): void {\r\n        if (polygon.length >= 2) {\r\n            this.context.fillStyle = this.fillColor.toStringRGB();\r\n            this.context.lineWidth = 1; // do not adapt with cssPixel for performance reasons on mobile devices\r\n\r\n            this.context.beginPath();\r\n\r\n            this.context.moveTo((polygon[0].x + offset.x) * this.cssPixel, (polygon[0].y + offset.y) * this.cssPixel);\r\n\r\n            for (let iP = 1; iP < polygon.length; iP++) {\r\n                this.context.lineTo((polygon[iP].x + offset.x) * this.cssPixel, (polygon[iP].y + offset.y) * this.cssPixel);\r\n            }\r\n\r\n            this.context.closePath();\r\n            this.context.fill();\r\n            this.context.stroke();\r\n        }\r\n    }\r\n\r\n    public drawEllipses(ellipses: IEllipse[], color: Color): void {\r\n        this.context.fillStyle = color.toStringRGBA(this.ellipseOpacity);\r\n\r\n        if (typeof this.context.ellipse !== \"function\") {\r\n            this.context.ellipse = ellipsePolyfill;\r\n        }\r\n\r\n        for (const ellipse of ellipses) {\r\n            this.context.beginPath();\r\n            this.context.ellipse(ellipse.center.x * this.cssPixel, ellipse.center.y * this.cssPixel, 0.5 * ellipse.width * this.cssPixel, 0.5 * ellipse.height * this.cssPixel, ellipse.orientation, 0, 2 * Math.PI);\r\n            this.context.fill();\r\n            this.context.closePath();\r\n        }\r\n    }\r\n}\r\n\r\nexport {\r\n    PlotterCanvas2D,\r\n};\r\n\r\n","import { Plotter } from \"./plotter\";\r\n\r\nimport \"../page-interface-generated\";\r\n\r\n\r\nabstract class PlotterCanvas extends Plotter {\r\n    protected readonly canvas: HTMLCanvasElement;\r\n    protected readonly cssPixel: number;\r\n\r\n    public _width: number;\r\n    public _height: number;\r\n\r\n    public constructor() {\r\n        super();\r\n\r\n        this.canvas = Page.Canvas.getCanvas();\r\n        this.cssPixel = window.devicePixelRatio ?? 1;\r\n        this.adjustToCanvas();\r\n    }\r\n\r\n    public adjustToCanvas(): void {\r\n        const actualWidth = Math.floor(this.cssPixel * this.canvas.clientWidth);\r\n        const actualHeight = Math.floor(this.cssPixel * this.canvas.clientHeight);\r\n\r\n        if (this.canvas.width !== actualWidth || this.canvas.height !== actualHeight) {\r\n            this.canvas.width = actualWidth;\r\n            this.canvas.height = actualHeight;\r\n        }\r\n\r\n        this._width = this.canvas.clientWidth;\r\n        this._height = this.canvas.clientHeight;\r\n    }\r\n\r\n    public get width(): number {\r\n        return this._width;\r\n    }\r\n\r\n    public get height(): number {\r\n        return this._height;\r\n    }\r\n}\r\n\r\nexport {\r\n    PlotterCanvas,\r\n};\r\n\r\n","import { gl, initGL } from \"../gl-utils/gl-canvas\";\r\nimport { Shader } from \"../gl-utils/shader\";\r\nimport * as ShaderManager from \"../gl-utils/shader-manager\";\r\n\r\nimport { IEllipse, IPoint } from \"../interfaces\";\r\nimport { Color } from \"./color\";\r\nimport { Line } from \"./plotter\";\r\nimport { PlotterCanvas } from \"./plotter-canvas-base\";\r\n\r\nimport \"../page-interface-generated\";\r\n\r\n\r\nenum EBatchType {\r\n    LINES,\r\n    POLYGONS,\r\n    ELLIPSES,\r\n}\r\n\r\ninterface IBatch {\r\n    type: EBatchType;\r\n    batchId: number;\r\n}\r\n\r\ninterface ILinesBatch extends IBatch {\r\n    type: EBatchType.LINES;\r\n    lines: Line[];\r\n    nbSegments: number;\r\n}\r\n\r\ninterface IEllipsesBatch extends IBatch {\r\n    type: EBatchType.ELLIPSES;\r\n    ellipsesList: IEllipse[];\r\n    color: Color;\r\n}\r\n\r\ninterface IPolygonsBatch extends IBatch {\r\n    outline: IPoint[];\r\n    center: IPoint;\r\n}\r\n\r\nfunction loadShader(name: string, callback: (loadedShader: Shader) => unknown): void {\r\n    ShaderManager.buildShader({\r\n        vertexFilename: `${name}.vert`,\r\n        fragmentFilename: `${name}.frag`,\r\n        injected: {},\r\n    }, (builtShader: Shader | null) => {\r\n        if (builtShader === null) {\r\n            const errorMessage = `Failed to load or build the ${name} shader.`;\r\n            Page.Demopage.setErrorMessage(`shader-${name}`, errorMessage);\r\n            throw new Error(errorMessage);\r\n        }\r\n        callback(builtShader);\r\n    });\r\n}\r\n\r\nclass PlotterCanvasWebGL extends PlotterCanvas {\r\n    private linesShader: Shader;\r\n    private readonly linesVBOId: WebGLBuffer;\r\n\r\n    private ellipsesShader: Shader;\r\n    private readonly ellipsesVBOId: WebGLBuffer;\r\n\r\n    private polygonsShader: Shader;\r\n    private readonly corollaVBOId: WebGLBuffer;\r\n    private readonly corollaIndexVBOId: WebGLBuffer;\r\n\r\n    private batches: IBatch[];\r\n\r\n    public constructor() {\r\n        super();\r\n\r\n        if (!initGL()) {\r\n            throw new Error(\"Failed to initialize WebGL.\");\r\n        }\r\n        gl.enable(gl.BLEND);\r\n        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n        gl.enable(gl.DEPTH_TEST);\r\n        gl.depthFunc(gl.LEQUAL);\r\n        gl.clearDepth(1);\r\n\r\n        this.linesVBOId = gl.createBuffer();\r\n        this.ellipsesVBOId = gl.createBuffer();\r\n        this.corollaVBOId = gl.createBuffer();\r\n        this.corollaIndexVBOId = gl.createBuffer();\r\n\r\n        loadShader(\"lines\", (shader: Shader) => { this.linesShader = shader; });\r\n        loadShader(\"ellipses\", (shader: Shader) => { this.ellipsesShader = shader; });\r\n        loadShader(\"polygons\", (shader: Shader) => { this.polygonsShader = shader; });\r\n    }\r\n\r\n    public initializeInternal(): void {\r\n        gl.viewport(0, 0, this.width * this.cssPixel, this.height * this.cssPixel);\r\n        gl.clearColor(this.fillColor.rNormalized, this.fillColor.gNormalized, this.fillColor.bNormalized, 1);\r\n        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); // tslint:disable-line no-bitwise\r\n\r\n        this.batches = [];\r\n    }\r\n\r\n    // tslint:disable-next-line no-empty\r\n    public finalize(): void {\r\n        const linesBatch: ILinesBatch[] = [];\r\n        const polygonsBatch: IPolygonsBatch[] = [];\r\n        const ellipsesBatch: IEllipsesBatch[] = [];\r\n\r\n        for (const batch of this.batches) {\r\n            if (batch.type === EBatchType.LINES) {\r\n                linesBatch.push(batch as ILinesBatch);\r\n            } else if (batch.type === EBatchType.POLYGONS) {\r\n                polygonsBatch.push(batch as IPolygonsBatch);\r\n            } else if (batch.type === EBatchType.ELLIPSES) {\r\n                ellipsesBatch.push(batch as IEllipsesBatch);\r\n            }\r\n        }\r\n\r\n        if (linesBatch.length > 0) {\r\n            this.drawLinesBatches(linesBatch);\r\n        }\r\n\r\n        gl.depthMask(true); // write to depth buffer\r\n        if (polygonsBatch.length > 0) {\r\n            this.drawPolygonsBatches(polygonsBatch);\r\n        }\r\n\r\n        gl.depthMask(false); // don't write to depth buffer because ellipses are not opaque\r\n        if (ellipsesBatch.length > 0) {\r\n            this.drawEllipseBatches(ellipsesBatch);\r\n        }\r\n        this.batches = [];\r\n    }\r\n\r\n    public drawLines(lines: Line[]): void {\r\n        const nonTrivalLines: Line[] = [];\r\n\r\n        let nbSegments = 0;\r\n        for (const line of lines) {\r\n            if (line.length >= 2) {\r\n                nbSegments += line.length - 1;\r\n                nonTrivalLines.push(line);\r\n            }\r\n        }\r\n\r\n        if (nonTrivalLines.length > 0) {\r\n            const linesBatch: ILinesBatch = {\r\n                type: EBatchType.LINES,\r\n                lines: nonTrivalLines,\r\n                nbSegments,\r\n                batchId: this.batches.length,\r\n            };\r\n\r\n            this.batches.push(linesBatch);\r\n        }\r\n    }\r\n\r\n    public drawPolygon(polygon: Line, offset: IPoint): void {\r\n        if (polygon.length > 0) {\r\n            const outline: IPoint[] = [];\r\n            for (const point of polygon) {\r\n                outline.push({\r\n                    x: point.x + offset.x,\r\n                    y: point.y + offset.y,\r\n                });\r\n            }\r\n\r\n            const polygonBatch: IPolygonsBatch = {\r\n                type: EBatchType.POLYGONS,\r\n                outline,\r\n                center: offset,\r\n                batchId: this.batches.length,\r\n            };\r\n            this.batches.push(polygonBatch);\r\n        }\r\n    }\r\n\r\n    public drawEllipses(ellipses: IEllipse[], color: Color): void {\r\n        if (ellipses.length > 0) {\r\n            const ellipsesBatch: IEllipsesBatch = {\r\n                type: EBatchType.ELLIPSES,\r\n                ellipsesList: ellipses,\r\n                color,\r\n                batchId: this.batches.length,\r\n            };\r\n            this.batches.push(ellipsesBatch);\r\n        }\r\n    }\r\n\r\n    private drawLinesBatches(batches: ILinesBatch[]) {\r\n        if (this.linesShader) {\r\n            let totalNbSegments = 0;\r\n            for (const batch of batches) {\r\n                totalNbSegments += batch.nbSegments;\r\n            }\r\n\r\n            const buffer = new Float32Array(2 * 2 * totalNbSegments);\r\n            {\r\n                let i = 0;\r\n                for (const batch of batches) {\r\n                    for (const line of batch.lines) {\r\n                        buffer[i++] = line[0].x;\r\n                        buffer[i++] = line[0].y;\r\n\r\n                        for (let iP = 1; iP < line.length - 1; iP++) {\r\n                            buffer[i++] = line[iP].x;\r\n                            buffer[i++] = line[iP].y;\r\n                            buffer[i++] = line[iP].x;\r\n                            buffer[i++] = line[iP].y;\r\n                        }\r\n\r\n                        buffer[i++] = line[line.length - 1].x;\r\n                        buffer[i++] = line[line.length - 1].y;\r\n                    }\r\n                }\r\n            }\r\n\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, this.linesVBOId);\r\n            gl.bufferData(gl.ARRAY_BUFFER, buffer, gl.DYNAMIC_DRAW);\r\n\r\n            this.linesShader.u[\"uScreenSize\"].value = [this.width, this.height];\r\n            this.linesShader.u[\"uColor\"].value = [this.lineColor.rNormalized, this.lineColor.gNormalized, this.lineColor.bNormalized, 1];\r\n\r\n            this.linesShader.use();\r\n            const aVertexLoc = this.linesShader.a[\"aVertex\"].loc;\r\n            gl.enableVertexAttribArray(aVertexLoc);\r\n\r\n            const FLOAT_SIZE_IN_BYTES = 4;\r\n            let batchStartIndex = 0;\r\n            for (const batch of batches) {\r\n                this.linesShader.u[\"uDepth\"].value = this.computeBatchDepth(batch);\r\n                this.linesShader.bindUniforms();\r\n                gl.vertexAttribPointer(aVertexLoc, 2, gl.FLOAT, false, 0, 2 * batchStartIndex * FLOAT_SIZE_IN_BYTES);\r\n                const nbVertices = 2 * batch.nbSegments;\r\n                gl.drawArrays(gl.LINES, 0, nbVertices);\r\n                batchStartIndex += nbVertices;\r\n            }\r\n        }\r\n    }\r\n\r\n    private drawPolygonsBatches(batches: IPolygonsBatch[]): void {\r\n        if (this.polygonsShader) {\r\n            let totalNbVertices = 0;\r\n            let totalNbTriangles = 0;\r\n            let totalNbLines = 0;\r\n            for (const polygon of batches) {\r\n                totalNbVertices += 1 + polygon.outline.length;\r\n                totalNbTriangles += polygon.outline.length;\r\n                totalNbLines += polygon.outline.length;\r\n            }\r\n\r\n            const verticesBuffer = new Float32Array(4 * totalNbVertices);\r\n            {\r\n                let iVertice = 0;\r\n                for (const polygon of batches) {\r\n                    const polygonDepth = this.computeBatchDepth(polygon);\r\n                    verticesBuffer[iVertice++] = polygon.center.x;\r\n                    verticesBuffer[iVertice++] = polygon.center.y;\r\n                    verticesBuffer[iVertice++] = polygonDepth;\r\n                    verticesBuffer[iVertice++] = 0; // padding for alignment\r\n\r\n                    for (const outlinePoint of polygon.outline) {\r\n                        verticesBuffer[iVertice++] = outlinePoint.x;\r\n                        verticesBuffer[iVertice++] = outlinePoint.y;\r\n                        verticesBuffer[iVertice++] = polygonDepth;\r\n                        verticesBuffer[iVertice++] = 0; // padding for alignment\r\n                    }\r\n                }\r\n            }\r\n\r\n            const indicesBuffer = new Uint16Array(2 * totalNbLines + 3 * totalNbTriangles);\r\n            {\r\n                let iIndex = 0;\r\n                let iVerticeIndex = 0;\r\n                for (const polygon of batches) {\r\n                    const indexOfPolygonCenter = iVerticeIndex;\r\n\r\n                    for (let iPoint = 0; iPoint < polygon.outline.length - 1; iPoint++) {\r\n                        indicesBuffer[iIndex++] = indexOfPolygonCenter;\r\n                        indicesBuffer[iIndex++] = indexOfPolygonCenter + iPoint + 1;\r\n                        indicesBuffer[iIndex++] = indexOfPolygonCenter + iPoint + 2;\r\n                    }\r\n                    indicesBuffer[iIndex++] = indexOfPolygonCenter;\r\n                    indicesBuffer[iIndex++] = indexOfPolygonCenter + polygon.outline.length;\r\n                    indicesBuffer[iIndex++] = indexOfPolygonCenter + 1;\r\n\r\n                    iVerticeIndex += polygon.outline.length + 1;\r\n                }\r\n\r\n                iVerticeIndex = 0;\r\n                for (const polygon of batches) {\r\n                    for (let iPoint = 0; iPoint < polygon.outline.length - 1; iPoint++) {\r\n                        indicesBuffer[iIndex++] = iVerticeIndex + iPoint + 1;\r\n                        indicesBuffer[iIndex++] = iVerticeIndex + iPoint + 2;\r\n                    }\r\n                    indicesBuffer[iIndex++] = iVerticeIndex + polygon.outline.length;\r\n                    indicesBuffer[iIndex++] = iVerticeIndex + 1;\r\n\r\n                    iVerticeIndex += polygon.outline.length + 1;\r\n                }\r\n            }\r\n\r\n            this.polygonsShader.u[\"uScreenSize\"].value = [this.width, this.height];\r\n\r\n            this.polygonsShader.use();\r\n\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, this.corollaVBOId);\r\n            gl.bufferData(gl.ARRAY_BUFFER, verticesBuffer, gl.DYNAMIC_DRAW);\r\n            const aDataLoc = this.polygonsShader.a[\"aData\"].loc;\r\n            gl.enableVertexAttribArray(aDataLoc);\r\n            gl.vertexAttribPointer(aDataLoc, 4, gl.FLOAT, false, 0, 0);\r\n\r\n            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.corollaIndexVBOId);\r\n            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indicesBuffer, gl.DYNAMIC_DRAW);\r\n\r\n            this.polygonsShader.u[\"uColor\"].value = [this.fillColor.rNormalized, this.fillColor.gNormalized, this.fillColor.bNormalized, 1];\r\n            this.polygonsShader.bindUniforms();\r\n            gl.drawElements(gl.TRIANGLES, 3 * totalNbTriangles, gl.UNSIGNED_SHORT, 0);\r\n\r\n            this.polygonsShader.u[\"uColor\"].value = [this.lineColor.rNormalized, this.lineColor.gNormalized, this.lineColor.bNormalized, 2];\r\n            this.polygonsShader.bindUniforms();\r\n            const UNSIGNED_SHORT_SIZE_IN_BYTES = 2;\r\n            gl.drawElements(gl.LINES, 2 * totalNbLines, gl.UNSIGNED_SHORT, 3 * totalNbTriangles * UNSIGNED_SHORT_SIZE_IN_BYTES);\r\n        }\r\n    }\r\n\r\n    private drawEllipseBatches(batches: IEllipsesBatch[]): void {\r\n        if (this.ellipsesShader) {\r\n            let totalNbPoints = 0;\r\n            for (const ellipseBatch of batches) {\r\n                totalNbPoints += ellipseBatch.ellipsesList.length;\r\n            }\r\n\r\n            const buffer = new Float32Array(8 * totalNbPoints);\r\n            {\r\n                let i = 0;\r\n                for (const ellipseBatch of batches) {\r\n                    const batchDepth = this.computeBatchDepth(ellipseBatch);\r\n\r\n                    for (const ellipse of ellipseBatch.ellipsesList) {\r\n                        const widestSide = Math.ceil(Math.max(1, ellipse.width, ellipse.height)); // integer\r\n                        const proportions = Math.min(ellipse.width, ellipse.height) / widestSide; // in [0, 1]\r\n                        const encodedDimensions = Math.ceil(widestSide * this.cssPixel) + proportions;\r\n\r\n                        buffer[i++] = ellipse.center.x;\r\n                        buffer[i++] = ellipse.center.y;\r\n                        buffer[i++] = encodedDimensions;\r\n                        buffer[i++] = batchDepth;\r\n\r\n                        buffer[i++] = ellipseBatch.color.rNormalized;\r\n                        buffer[i++] = ellipseBatch.color.gNormalized;\r\n                        buffer[i++] = ellipseBatch.color.bNormalized;\r\n                        buffer[i++] = ellipse.orientation;\r\n                    }\r\n                }\r\n            }\r\n\r\n            this.ellipsesShader.u[\"uScreenSize\"].value = [this.width, this.height];\r\n            this.ellipsesShader.u[\"uPetalAlpha\"].value = this.ellipseOpacity;\r\n\r\n            this.ellipsesShader.use();\r\n            this.ellipsesShader.bindUniforms();\r\n\r\n            // gl.depthMask(false); // don't write to depth buffer\r\n\r\n            const BYTES_PER_FLOAT = 4;\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, this.ellipsesVBOId);\r\n            gl.bufferData(gl.ARRAY_BUFFER, buffer, gl.DYNAMIC_DRAW);\r\n            const aData1Loc = this.ellipsesShader.a[\"aData1\"].loc;\r\n            gl.enableVertexAttribArray(aData1Loc);\r\n            gl.vertexAttribPointer(aData1Loc, 4, gl.FLOAT, false, 2 * 4 * BYTES_PER_FLOAT, 0);\r\n            const aData2Loc = this.ellipsesShader.a[\"aData2\"].loc;\r\n            gl.enableVertexAttribArray(aData2Loc);\r\n            gl.vertexAttribPointer(aData2Loc, 4, gl.FLOAT, false, 2 * 4 * BYTES_PER_FLOAT, 4 * BYTES_PER_FLOAT);\r\n            gl.drawArrays(gl.POINTS, 0, totalNbPoints);\r\n        }\r\n    }\r\n\r\n    private computeBatchDepth(batch: IBatch): number {\r\n        return 1.9 * (0.5 - (batch.batchId / this.batches.length));\r\n    }\r\n}\r\n\r\nexport {\r\n    PlotterCanvasWebGL,\r\n};\r\n\r\n","import { IEllipse, IPoint } from \"../interfaces\";\r\nimport { Color } from \"./color\";\r\nimport { Line, Plotter } from \"./plotter\";\r\n\r\nimport \"../page-interface-generated\";\r\n\r\n\r\nfunction radianToDegree(radian: number) {\r\n    return 180 * radian / Math.PI;\r\n}\r\n\r\nclass PlotterSvg extends Plotter {\r\n    private readonly stringParts: string[];\r\n    private readonly width: number;\r\n    private readonly height: number;\r\n\r\n    public constructor(width: number, height: number) {\r\n        super();\r\n        this.stringParts = [];\r\n        this.width = width;\r\n        this.height = height;\r\n    }\r\n\r\n    protected initializeInternal(): void {\r\n        this.stringParts.push(`<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>`);\r\n        this.stringParts.push(`<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" viewBox=\"0 0 ${this.width} ${this.height}\">`);\r\n\r\n        this.stringParts.push(`\\t<rect fill=\"${this.fillColor.toStringRGB()}\" stroke=\"none\" x=\"0\" y=\"0\" width=\"${this.width}\" height=\"${this.height}\"/>`);\r\n        this.stringParts.push(`\\t<g fill=\"${this.fillColor.toStringRGB()}\" stroke=\"${this.lineColor.toStringRGB()}\" stroke-width=\"1\">`);\r\n    }\r\n\r\n    public finalize(): void {\r\n        this.stringParts.push(\"\\t</g>\");\r\n        this.stringParts.push(\"</svg>\");\r\n    }\r\n\r\n    public toString(): string {\r\n        return this.stringParts.join(\"\\n\");\r\n    }\r\n\r\n    public drawLines(lines: Line[]): void {\r\n        if (lines.length >= 1) {\r\n            this.stringParts.push(`\\t\\t<g fill=\"none\">`);\r\n\r\n            for (const line of lines) {\r\n                if (line.length >= 2) {\r\n                    this.stringParts.push(`\\t\\t\\t<path d=\"${PlotterSvg.computePath(line)}\"/>`);\r\n                }\r\n            }\r\n\r\n            this.stringParts.push(`\\t\\t</g>`);\r\n        }\r\n    }\r\n\r\n    public drawPolygon(polygon: Line, offset: IPoint): void {\r\n        if (polygon.length >= 2) {\r\n            const transform = `translate(${offset.x.toFixed(1)} ${offset.y.toFixed(1)})`;\r\n            this.stringParts.push(`\\t\\t<path d=\"${PlotterSvg.computePath(polygon)}Z\" transform=\"${transform}\"/>`);\r\n        }\r\n    }\r\n\r\n    public drawEllipses(ellipses: IEllipse[], color: Color): void {\r\n        if (ellipses.length >= 1) {\r\n            this.stringParts.push(`\\t\\t<g stroke=\"none\" fill=\"${color.toStringRGBA(this.ellipseOpacity)}\">`);\r\n            for (const ellipse of ellipses) {\r\n                const transform = `translate(${ellipse.center.x.toFixed(1)} ${ellipse.center.y.toFixed(1)}) rotate(${radianToDegree(ellipse.orientation).toFixed(1)})`;\r\n                this.stringParts.push(`\\t\\t\\t<ellipse cx=\"0\" cy=\"0\" rx=\"${(0.5 * ellipse.width).toFixed(1)}\" ry=\"${(0.5 * ellipse.height).toFixed(1)}\" transform=\"${transform}\"/>`);\r\n            }\r\n            this.stringParts.push(`\\t\\t</g>`);\r\n        }\r\n    }\r\n\r\n    private static computePath(line: Line): string {\r\n        const start = `M${line[0].x.toFixed(1)},${line[0].y.toFixed(1)}L`;\r\n\r\n        const pathParts: string[] = [];\r\n        for (let iP = 1; iP < line.length; iP++) {\r\n            pathParts.push(`${line[iP].x.toFixed(1)},${line[iP].y.toFixed(1)}`);\r\n        }\r\n\r\n        return start + pathParts.join(\" \");\r\n    }\r\n}\r\n\r\nexport { PlotterSvg };\r\n\r\n","import { IEllipse, IPoint } from \"../interfaces\";\r\nimport { Color } from \"./color\";\r\n\r\nimport \"../page-interface-generated\";\r\n\r\n\r\ntype Line = IPoint[];\r\n\r\nabstract class Plotter {\r\n    protected fillColor: Color;\r\n    protected lineColor: Color;\r\n    protected ellipseOpacity: number; // in [0,1]\r\n\r\n    public initialize(fillColor: Color, lineColor: Color, ellipseOpacity: number): void {\r\n        this.fillColor = fillColor;\r\n        this.lineColor = lineColor;\r\n        this.ellipseOpacity = ellipseOpacity;\r\n        this.initializeInternal();\r\n    }\r\n\r\n    protected abstract initializeInternal(): void;\r\n\r\n    public abstract finalize(): void;\r\n\r\n    public abstract drawLines(lines: Line[]): void;\r\n\r\n    public abstract drawPolygon(polygon: Line, offset: IPoint): void;\r\n\r\n    public abstract drawEllipses(ellipses: IEllipse[], color: Color): void;\r\n}\r\n\r\nexport {\r\n    Line,\r\n    Plotter,\r\n};\r\n\r\n","import { IPoint, IVector } from \"./interfaces\";\r\nimport { Line } from \"./plotting/plotter\";\r\n\r\ninterface IRopeNode {\r\n    pos: IPoint;\r\n    previousPos: IPoint;\r\n    acc: IVector;\r\n}\r\n\r\nfunction createRopeNode(x: number, y: number): IRopeNode {\r\n    return {\r\n        pos: { x, y },\r\n        previousPos: { x, y },\r\n        acc: { x: 0, y: 0 },\r\n    };\r\n}\r\n\r\nconst NB_ITERATIONS = 8;\r\n\r\nclass Rope {\r\n    public dampening: number = 1;\r\n\r\n    private readonly nodes: IRopeNode[];\r\n    private readonly segmentLength: number;\r\n    private readonly totalLength: number;\r\n\r\n    public constructor(startingPoint: IPoint, segmentLength: number, nbNodes: number) {\r\n        this.segmentLength = segmentLength;\r\n        this.totalLength = segmentLength * nbNodes;\r\n\r\n        this.nodes = [];\r\n        this.nodes.push(createRopeNode(startingPoint.x, startingPoint.y));\r\n        for (let iN = 0; iN < nbNodes; iN++) {\r\n            const angle = 2 * Math.PI * Math.random();\r\n            this.nodes.push(createRopeNode(\r\n                this.nodes[this.nodes.length - 1].pos.x + segmentLength * Math.cos(angle),\r\n                this.nodes[this.nodes.length - 1].pos.y + Math.abs(segmentLength * Math.sin(angle))\r\n            ));\r\n        }\r\n    }\r\n\r\n    public getDrawableLine(minSegmentLength: number): Line {\r\n        return this.computeSmoothLine(this.totalLength / minSegmentLength);\r\n    }\r\n\r\n    public update(dt: number, origin: IPoint, endAcceleration: IVector): void {\r\n        this.applyForces(endAcceleration);\r\n        this.applyVerlet(dt);\r\n\r\n        for (let i = 0; i < NB_ITERATIONS; i++) {\r\n            this.applyConstraints(origin);\r\n        }\r\n    }\r\n\r\n    public get endPosition(): IPoint {\r\n        return this.nodes[this.nodes.length - 1].pos;\r\n    }\r\n\r\n    public get highestPoint(): number {\r\n        let highest = 1000000;\r\n        for (const node of this.nodes) {\r\n            if (node.pos.y < highest) {\r\n                highest = node.pos.y;\r\n            }\r\n        }\r\n        return highest;\r\n    }\r\n\r\n    private applyForces(endAcceleration: IVector): void {\r\n        for (let iN = 1; iN < this.nodes.length; iN++) {\r\n            this.nodes[iN].acc.x = 0;\r\n            this.nodes[iN].acc.y = 0;\r\n        }\r\n\r\n        this.nodes[this.nodes.length - 1].acc.x += endAcceleration.x;\r\n        this.nodes[this.nodes.length - 1].acc.y += endAcceleration.y;\r\n    }\r\n\r\n    private applyVerlet(dt: number): void {\r\n        for (const node of this.nodes) {\r\n            // CURRENT_VELOCITY = (CURRENT_POSITION - PREVIOUS_POSITION) / DT\r\n            // NEW_VELOCITY = DAMPENING * CURRENT_VELOCITY + CURRENT_ACCELERATION * DT\r\n            // NEW_POSITION = CURRENT_POSITION + NEW_VELOCITY * DT\r\n\r\n            const newPosX = node.pos.x + this.dampening * (node.pos.x - node.previousPos.x) + dt * dt * node.acc.x;\r\n            const newPosY = node.pos.y + this.dampening * (node.pos.y - node.previousPos.y) + dt * dt * node.acc.y;\r\n\r\n            node.previousPos.x = node.pos.x;\r\n            node.previousPos.y = node.pos.y;\r\n            node.pos.x = newPosX;\r\n            node.pos.y = newPosY;\r\n        }\r\n    }\r\n\r\n    private applyConstraints(origin: IPoint): void {\r\n        const EPSILON = 0.000001;\r\n        this.nodes[0].pos.x = origin.x;\r\n        this.nodes[0].pos.y = origin.y;\r\n\r\n        for (let iN = 1; iN < this.nodes.length; iN++) {\r\n            const dX = this.nodes[iN].pos.x - this.nodes[iN - 1].pos.x;\r\n            const dY = this.nodes[iN].pos.y - this.nodes[iN - 1].pos.y;\r\n            const distanceToPrevious = Math.sqrt(dX * dX + dY * dY);\r\n            const correction = 0.5 * (1 - this.segmentLength / (distanceToPrevious + EPSILON));\r\n            const correctionX = dX * correction;\r\n            const correctionY = dY * correction;\r\n\r\n            this.nodes[iN].pos.x -= correctionX;\r\n            this.nodes[iN].pos.y -= correctionY;\r\n            this.nodes[iN - 1].pos.x += correctionX;\r\n            this.nodes[iN - 1].pos.y += correctionY;\r\n        }\r\n    }\r\n\r\n    private computeSmoothLine(minimumPoints: number): IPoint[] {\r\n        let points: IPoint[] = [];\r\n        for (const node of this.nodes) {\r\n            points.push(node.pos);\r\n        }\r\n\r\n        while (points.length < minimumPoints) {\r\n            points = Rope.subdivideLine(points, 0.333);\r\n        }\r\n        return points;\r\n    }\r\n\r\n    // Chaikin\r\n    private static subdivideLine(sourcePoints: IPoint[], ratio: number): IPoint[] {\r\n        const newPoints: IPoint[] = [];\r\n        newPoints.push(sourcePoints[0]);\r\n\r\n        for (let iP = 0; iP < sourcePoints.length - 1; iP++) {\r\n            newPoints.push({\r\n                x: sourcePoints[iP].x * (1 - ratio) + sourcePoints[iP + 1].x * ratio,\r\n                y: sourcePoints[iP].y * (1 - ratio) + sourcePoints[iP + 1].y * ratio,\r\n            });\r\n            newPoints.push({\r\n                x: sourcePoints[iP].x * ratio + sourcePoints[iP + 1].x * (1 - ratio),\r\n                y: sourcePoints[iP].y * ratio + sourcePoints[iP + 1].y * (1 - ratio),\r\n            });\r\n        }\r\n\r\n        newPoints.push(sourcePoints[sourcePoints.length - 1]);\r\n        return newPoints;\r\n    }\r\n}\r\n\r\nexport { Rope };\r\n\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { FlowersManager } from \"./flowers-manager\";\r\nimport { ForceField } from \"./force-field\";\r\nimport { downloadTextFile } from \"./helpers\";\r\nimport { Parameters } from \"./parameters\";\r\n\r\nimport { Plotter } from \"./plotting/plotter\";\r\nimport { PlotterCanvas2D } from \"./plotting/plotter-canvas-2d\";\r\nimport { PlotterCanvas } from \"./plotting/plotter-canvas-base\";\r\nimport { PlotterCanvasWebGL } from \"./plotting/plotter-canvas-webgl\";\r\nimport { PlotterSvg } from \"./plotting/plotter-svg\";\r\n\r\nimport \"./page-interface-generated\";\r\n\r\n\r\nfunction plot(flowersManager: FlowersManager, plotter: Plotter): void {\r\n    plotter.initialize(Parameters.backgroundColor, Parameters.linesColor, Parameters.petalsOpacity);\r\n    flowersManager.draw(plotter);\r\n    plotter.finalize();\r\n}\r\n\r\nfunction main() {\r\n    const plotter: PlotterCanvas = Parameters.useCanvas2D ? new PlotterCanvas2D() : new PlotterCanvasWebGL();\r\n    const flowersManager = new FlowersManager();\r\n\r\n    Parameters.addResetObserver(() => { flowersManager.reset(); });\r\n    Parameters.addDownloadObserver(() => { exportAsSvg(flowersManager, plotter.width, plotter.height); });\r\n\r\n    const maxDt = 1 / 60;\r\n    let lastUpdate = performance.now();\r\n    function mainLoop() {\r\n        const now = performance.now();\r\n        const dt = Parameters.speed * Math.min(maxDt, 0.001 * (now - lastUpdate));\r\n        lastUpdate = now;\r\n\r\n        plotter.adjustToCanvas();\r\n\r\n        flowersManager.manage(plotter.width, plotter.height);\r\n\r\n        const forceField = new ForceField(Parameters.mousePositionInPixels, 500);\r\n        flowersManager.update(dt, forceField);\r\n\r\n        plot(flowersManager, plotter);\r\n\r\n        requestAnimationFrame(mainLoop);\r\n    }\r\n\r\n    requestAnimationFrame(mainLoop);\r\n}\r\n\r\nfunction exportAsSvg(flowersManager: FlowersManager, width: number, height: number): void {\r\n    const plotter = new PlotterSvg(width, height);\r\n    plot(flowersManager, plotter);\r\n\r\n    const svgText = plotter.toString();\r\n    downloadTextFile(\"flowers.svg\", svgText);\r\n}\r\n\r\nmain();\r\n"],"sourceRoot":""}